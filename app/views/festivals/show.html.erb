<%# Display one festival schedule: /festivals/1 -%>
<% content_for :title do %>Schedule for <%= @festival.name %><% end %>

<%= render :partial => "festivals/header", :locals => { :festival => @festival, :hide_tabs => @read_only } %>

<div class="instructions">
<% if !logged_in? %>
<p>Here's the festival schedule; if you log in, you'll be able to click on the grid to 
schedule screenings.</p>
<% else %>
<% if @read_only %>
<p>Here is <b><%=h @displaying_user.username %></b>'s current festival schedule. Here's what the colors mean:</p>
<% else %>
<p>Your festival schedule is below; you can click individual screenings to select or unselect them.
When you select a screening, conflicting screenings and other screenings of that film will be unselected
for you. Here's what the colors mean:</p>
<% end %>
<ul class="legend">
<li><span class="scheduled example">a screening you've selected;</span> you're going to this screening.</li>
<li><span class="otherscheduled example">a screening of a film you've selected to see at another time;</span> you're going to a different screening of this film.</li>
<li><span class="unscheduled example">a screening of a film you've prioritized, but haven't scheduled;</span> you want to see this film, but haven't picked a screening yet.</li>
<li><span class="unranked example">a screening of a film you've prioritized at the lowest setting, or haven't prioritized;</span> you're not planning on seeing this film.</li>
<li>The priority you gave each film (on the Film Priorities page) is shown with little circles: 
      <%= image_tag "priority/p3.png", :height => 10, :width => 46 %></li>
</ul>

<p>Also:</p>
<ul>
<% unless @read_only %>
<li>You can always go back to the "Your Film Priorities" tab and to adjust your priorities, then use the "Scheduling Assistant" to re-schedule the rest of the festival for you.</li>
<li>You can click <%= link_to "here", 
   reset_screenings_festival_url(@festival),
   :method => :post,
   :confirm => "Are you sure you want to unschedule all your screenings?" %> 
to un-select all your selected screenings and start over.</li>
<% end %>
<% if logged_in? || @read_only %>
<% pdf_url = @read_only \
     ? festival_user_url(\
         :festival_id => @festival.to_param, 
         :other_user_id => @displaying_user.to_param,
         :key => @displaying_user_subscription.key,
         :format => :pdf) \
     : festival_url(@festival, :format => :pdf) -%>
<li>You can <%= link_to "download a printable PDF of this schedule", 
                        pdf_url %>, 
which you can print with <a href="http://get.adobe.com/reader/" target="_blank">Adobe Reader</a>. (This is a list format; other formats coming soon).</li>
<% end %>
<% if logged_in? && !@read_only %>
<li>
  You can <%= link_to 'download this schedule in iCalendar format', 
                      icalendar_festival_url %>,
  or add it to your <%= link_to 'Google calendar', google_festival_url,
                                :target => "_blank" %>
  or <%= link_to 'My Yahoo! calendar', yahoo_festival_url,
                 :target => "_blank" %>.
</li>
<li>You can share your schedule with your friends by giving them this link:<br/><%= link_to h(readonly_festival_url), readonly_festival_url %></li>
<% end %>
</ul>
<% end %>
</div>

<% cache @cache_key do %>
<div id="days" class="days">
  <%= render :partial => "day", 
             :collection => days(@festival, @show_press) %>
</div>
<%= content_tag(:div,
                content_tag(:span,
                            "Revised at #{@festival.revised_at.strftime("%H:%M %a, %b %d")}"),
                :class => "revised") \
    if @festival.revised_at %>
<% end # caching -%>

<% content_for :page_scripts do %>
jQuery(function() {
  <%# Apply picks for this user -%>
  <%= @screening_javascript %>

  <%# Register for clicks on all our screenings -%>
  jQuery(".screening").click(function(e) {
    <%# Hide any other open details %>
    jQuery(".details").remove();

    <%# Grab more content? %>
    var screening = jQuery(this);
    var target_width = 400;
    var max_height = 250;
    jQuery.ajax({
      url: '/films/' + screening.attr('data-film_id')
            + '/screenings/' + screening.attr('id').split('-')[1] + '.js',
      error: function(xhr, status) {
        alert("A problem occurred trying to retrieve this screening's information. " +
              "We'll look into it; please try again later.");
      },
      success: function(raw_details) {
        var details = jQuery(raw_details);
        <%# Copy classes and other characteristics from the original %>
        jQuery.each(screening.attr('class').split(' '), function(i, name) {
          if (name != 'screening')
            details.addClass(name);
        });

        <%# Insert it in position, but transparent and at the target width %>
        details.css({
          left: screening.offset().left,
          top: screening.offset().top,
          opacity: "40%",
          width: target_width,
        });
        screening.before(details);
        console.info("screening at (" + screening.offset().left + ", " + screening.offset().top +
                     "), details at (" + details.offset().left + ", " + details.offset().top + ")");

        <%# Note its height at this width; this is how tall we'll make it %>
        var target_height = Math.min(details.height(), max_height)
        console.info("target height: " + target_height);

        <%# Now shrink it to fit, hide its overflow, and make it opaque %>
        details.css({
          overflow: "hidden",
          opacity: "100%",
          width: screening.width(),
          height: screening.height(),
        });

        <%# Zoom it open %>
        var params = {
          height: target_height,
          width: target_width,
        }
        if (details.offset().left > (jQuery(document).width() / 2))
          params["left"] = "-=" + (target_width - screening.width());
        details.animate(params, {
          duration: 'fast',
          complete: function() { details.css("overflow", "auto"); },
        });
      }
    });
  });
  jQuery(document).click(function(e) {
    <%# Hide any open details when anything else is *left*-clicked %>
    if (e.which == 1) jQuery(".details").remove();
  });
});
<% end -%>

